<?php
/**
 * Helper functions for XML-Lib generated pages
 *
 * Generated by xml-lib phpify
 * PSR-12 compliant
 */

/**
 * Escape text for safe HTML output
 *
 * @param string $text Text to escape
 * @return string Escaped text
 */
function escape_html(string $text): string
{
    return htmlspecialchars($text, ENT_QUOTES | ENT_HTML5, 'UTF-8');
}

/**
 * Escape attribute value for safe use in HTML attributes
 *
 * @param string $value Attribute value
 * @return string Escaped attribute value
 */
function escape_attr(string $value): string
{
    return htmlspecialchars($value, ENT_QUOTES | ENT_HTML5, 'UTF-8');
}

/**
 * Sanitize and validate URL
 *
 * @param string $url URL to sanitize
 * @return string|null Sanitized URL or null if invalid
 */
function sanitize_url(string $url): ?string
{
    // Remove dangerous protocols
    $dangerous = ['javascript:', 'data:', 'vbscript:', 'file:'];
    $lower_url = strtolower(trim($url));

    foreach ($dangerous as $protocol) {
        if (strpos($lower_url, $protocol) === 0) {
            return null;
        }
    }

    // Validate URL format
    if (filter_var($url, FILTER_VALIDATE_URL) === false && !str_starts_with($url, '#')) {
        // Allow fragment identifiers
        if (str_starts_with($url, '#')) {
            return $url;
        }
        return null;
    }

    return $url;
}

/**
 * Generate a URL-safe slug from text
 *
 * @param string $text Input text
 * @return string URL-safe slug
 */
function slugify(string $text): string
{
    // Convert to lowercase
    $slug = strtolower($text);

    // Replace non-alphanumeric with hyphens
    $slug = preg_replace('/[^a-z0-9]+/', '-', $slug);

    // Remove leading/trailing hyphens
    $slug = trim($slug, '-');

    // Limit length
    $slug = substr($slug, 0, 50);

    return $slug ?: 'untitled';
}

/**
 * Render a table from structured data
 *
 * @param array $headers Array of header rows
 * @param array $rows Array of data rows
 * @param string|null $caption Optional caption
 * @return string HTML table
 */
function render_table(array $headers, array $rows, ?string $caption = null): string
{
    $html = '<table class="content-table">';

    if ($caption !== null) {
        $html .= '<caption>' . escape_html($caption) . '</caption>';
    }

    if (!empty($headers)) {
        $html .= '<thead>';
        foreach ($headers as $row) {
            $html .= '<tr>';
            foreach ($row as $cell) {
                $html .= '<th>' . escape_html($cell) . '</th>';
            }
            $html .= '</tr>';
        }
        $html .= '</thead>';
    }

    if (!empty($rows)) {
        $html .= '<tbody>';
        foreach ($rows as $row) {
            $html .= '<tr>';
            foreach ($row as $cell) {
                $html .= '<td>' . escape_html($cell) . '</td>';
            }
            $html .= '</tr>';
        }
        $html .= '</tbody>';
    }

    $html .= '</table>';

    return $html;
}

/**
 * Render a figure with image and caption
 *
 * @param string $src Image source
 * @param string $alt Alt text
 * @param string|null $caption Optional caption
 * @param string|null $width Optional width
 * @param string|null $height Optional height
 * @return string HTML figure
 */
function render_figure(
    string $src,
    string $alt,
    ?string $caption = null,
    ?string $width = null,
    ?string $height = null
): string {
    $safe_src = sanitize_url($src);
    if ($safe_src === null) {
        return '<!-- Invalid image URL -->';
    }

    $html = '<figure class="content-figure">';
    $html .= '<img src="' . escape_attr($safe_src) . '" alt="' . escape_attr($alt) . '"';

    if ($width !== null) {
        $html .= ' width="' . escape_attr($width) . '"';
    }
    if ($height !== null) {
        $html .= ' height="' . escape_attr($height) . '"';
    }

    $html .= ' loading="lazy">';

    if ($caption !== null) {
        $html .= '<figcaption>' . escape_html($caption) . '</figcaption>';
    }

    $html .= '</figure>';

    return $html;
}

/**
 * Render footnotes section
 *
 * @param array $citations Array of citations/footnotes
 * @return string HTML footnotes section
 */
function render_footnotes(array $citations): string
{
    if (empty($citations)) {
        return '';
    }

    $html = '<section class="footnotes" role="doc-endnotes">';
    $html .= '<h2 id="footnotes">Footnotes</h2>';
    $html .= '<ol>';

    foreach ($citations as $id => $content) {
        $html .= '<li id="' . escape_attr($id) . '">';
        $html .= escape_html($content);
        $html .= '</li>';
    }

    $html .= '</ol>';
    $html .= '</section>';

    return $html;
}
